/*
 * Included:
 * jquery.treeview.js
 * create.js
 */

;(function(a){a.extend(a.fn,{swapClass:function(a,b){var c=this.filter('.'+a);this.filter('.'+b).removeClass(b).addClass(a);c.removeClass(a).addClass(b);return this;},replaceClass:function(a,b){return this.filter('.'+a).removeClass(a).addClass(b).end();},hoverClass:function(b){b=b||"hover";return this.hover(function(){a(this).addClass(b);},function(){a(this).removeClass(b);});},heightToggle:function(a,b){a?this.animate({height:"toggle"},a,b):this.each(function(){jQuery(this)[jQuery(this).is(":hidden")?"show":"hide"]();if(b)b.apply(this,arguments);});},heightHide:function(a,b){if(a)this.animate({height:"hide"},a,b);else{this.hide();if(b)this.each(b);}},prepareBranches:function(a){if(!a.prerendered){this.filter(":last-child:not(ul)").addClass(b.last);this.filter((a.collapsed?"":"."+b.closed)+":not(."+b.open+")").find(">ul").hide();}return this.filter(":has(>ul)");},applyClasses:function(c,d){this.filter(":has(>ul):not(:has(>a))").find(">span").click(function(b){d.apply(a(this).next());}).add(a("a",this)).hoverClass();if(!c.prerendered){this.filter(":has(>ul:hidden)").addClass(b.expandable).replaceClass(b.last,b.lastExpandable);this.not(":has(>ul:hidden)").addClass(b.collapsable).replaceClass(b.last,b.lastCollapsable);this.prepend("<div class=\""+b.hitarea+"\"/>").find("div."+b.hitarea).each(function(){var b="";a.each(a(this).parent().attr("class").split(" "),function(){b+=this+"-hitarea ";});a(this).addClass(b);});}this.find("div."+b.hitarea).click(d);},treeview:function(c){c=a.extend({cookieId:"treeview"},c);if(c.add)return this.trigger("add",[c.add]);if(c.toggle){var d=c.toggle;c.toggle=function(){return d.apply(a(this).parent()[0],arguments);};}function e(c,d){function e(d){return function(){f.apply(a("div."+b.hitarea,c).filter(function(){return d?a(this).parent("."+d).length:true;}));return false;};}a("a:eq(0)",d).click(e(b.collapsable));a("a:eq(1)",d).click(e(b.expandable));a("a:eq(2)",d).click(e());}function f(){a(this).parent().find(">.hitarea").swapClass(b.collapsableHitarea,b.expandableHitarea).swapClass(b.lastCollapsableHitarea,b.lastExpandableHitarea).end().swapClass(b.collapsable,b.expandable).swapClass(b.lastCollapsable,b.lastExpandable).find(">ul").heightToggle(c.animated,c.toggle);if(c.unique)a(this).parent().siblings().find(">.hitarea").replaceClass(b.collapsableHitarea,b.expandableHitarea).replaceClass(b.lastCollapsableHitarea,b.lastExpandableHitarea).end().replaceClass(b.collapsable,b.expandable).replaceClass(b.lastCollapsable,b.lastExpandable).find(">ul").heightHide(c.animated,c.toggle);}function g(){function b(a){return a?1:0;}var d=[];i.each(function(b,c){d[b]=a(c).is(":has(>ul:visible)")?1:0;});a.cookie(c.cookieId,d.join(""));}function h(){var b=a.cookie(c.cookieId);if(b){var d=b.split("");i.each(function(b,c){a(c).find(">ul")[parseInt(d[b])?"show":"hide"]();});}}this.addClass("treeview");var i=this.find("li").prepareBranches(c);switch(c.persist){case "cookie":var j=c.toggle;c.toggle=function(){g();if(j)j.apply(this,arguments);};h();break;case "location":var k=this.find("a").filter(function(){return this.href.toLowerCase()==location.href.toLowerCase();});if(k.length)k.addClass("selected").parents("ul, li").add(k.next()).show();break;}i.applyClasses(c,f);if(c.control){e(this,c.control);a(c.control).show();}return this.bind("add",function(d,e){a(e).prev().removeClass(b.last).removeClass(b.lastCollapsable).removeClass(b.lastExpandable).find(">.hitarea").removeClass(b.lastCollapsableHitarea).removeClass(b.lastExpandableHitarea);a(e).find("li").andSelf().prepareBranches(c).applyClasses(c,f);});}});var b=a.fn.treeview.classes={open:"open",closed:"closed",expandable:"expandable",expandableHitarea:"expandable-hitarea",lastExpandableHitarea:"lastExpandable-hitarea",collapsable:"collapsable",collapsableHitarea:"collapsable-hitarea",lastCollapsableHitarea:"lastCollapsable-hitarea",lastCollapsable:"lastCollapsable",lastExpandable:"lastExpandable",last:"last",hitarea:"hitarea"};a.fn.Treeview=a.fn.treeview;})(jQuery);var sock=null;if(window.document.location.protocol=="https:")var socket_protocol="wss";else var socket_protocol="ws";$(document).ready(function(){sock=new window.WebSocket(socket_protocol+"://"+window.document.location.host+"/createsocket");sock.onmessage=handleMessage;sock.onerror=function(a){console.log("socket error",a,sock);};sock.onopen=function(a){console.log("socket opened",a,sock);};sock.onclose=function(a){console.log("socket closed",a,sock);};$("#path").keyup(function(a){sock.send("request=exists&path="+$(this).val());});$("#path_browse").click(function(a){if($("#path_browse_div").hasClass("hidden")){$("#path_browse_div").removeClass("hidden");initTree();}else{$("#path_browse_div").addClass("hidden");$("#path_browse_div").empty();return false;}});$("#create").click(function(a){submitForm();});$(".filetree_item").live("click",function(){var a=$(this).next().html();$(".filetree_item").each(function(){$(this).removeClass("selected");});$(this).addClass("selected");$("#path").val(a);});});function initTree(){var a=$("#path_browse_div");var b=$("#root_dir").html();sock.send("request=filetree&rootDir="+b);}function submitForm(){var a=false;var b=$("#path").val();var c=$("#announce").val();if(!c){$("#announce").css("border","1px solid red").css("color","red").keydown(function(){$(this).css("border","").css("color","");});a=true;}var d=$("#piece").val();var e=$("#private").val();var f=$("#comment").val();if(!f)f=$("#comment").attr("placeholder");var g=$("#output").val();if(!g){var h="abcdefghijklmnopqrstuvwxyz";g="";for(i=0;i<15;i++)g+=h[Math.floor(Math.random()*26)];g+=".torrent";$("#output").val(g);}else if(g.indexOf(".torrent")!==g.length-8){g+=".torrent";$("#output").val(g);}if(a)return false;else{$("#progressbar").removeClass("hidden");$("#progressval").removeClass("hidden");$("#progressbar").progressbar({value:0});var i="request=create";i+="&path="+b;i+="&announce="+c;i+="&piece="+d;i+="&private="+e;i+="&comment="+f;i+="&output="+g;sock.send(i);}}function handleMessage(a){if(a.data.indexOf("ERROR")==0)console.log("socket error:",a.data);else{var b=JSON.parse(a.data);var c=b.request;var d=b.response;if(c=="filetree"){var e=$(d);e.treeview({collapsed:true});$("#path_browse_div").append(e);}else if(c=="exists")if(d)$("#path").css("color","");else $("#path").css("color","red");else if(c=="create")if(d===true){$("#progressbar").addClass("hidden");var f=b.output;constructTorrent(f);}else if(!isNaN(d))$("#progressbar").progressbar("option","value",d);else console.log(d);else console.log("request:",c,"response:",d);}}function constructTorrent(a){var b=$("<div />").addClass("downloadme");var c=$("<img />").attr("src","/images/document.png").attr("title","Download torrent");var d=$("<a href='/downloadcreation?filename="+a+"' />").append(c);b.append(d);$("#progressbar").parent().append(b);}
