var StatSocket=null,UpData=[],DownData=[],LoadData=[],MemData=[],MemTotal=null,HddData=[],HddTotal=null,HddFirst=null,netctx=null,sysctx=null,iolayer=null,tiplayer=null,iostage=null,cHeight=null,cWidth=null,cOriginX=null,cOriginY=null,eHeight=null,eWidth=null,xoffset=5,yoffset=6,nxoffset=55,nyoffset=10,maxValues=null,trackerData=null,pieSlices={},socket_protocol="https:"==window.document.location.protocol?"wss":"ws";
$(document).ready(function(){var a=window.location.pathname;StatSocket=new WebSocket(socket_protocol+"://"+window.location.host+a.substring(0,a.lastIndexOf("/")+1)+"statsocket");StatSocket.onmessage=onMessage;StatSocket.onopen=onOpen;StatSocket.onclose=onClose;StatSocket.onerror=onError;setInterval(function(){StatSocket.send("ping")},4E4)});function mainLoop(){StatSocket.send("request=global");setTimeout(mainLoop,1E3)}
function initTGraph(){clearCanvas($("#canvas-io"));iostage=new Kinetic.Stage({container:"canvas-io",width:800,height:420});iolayer=new Kinetic.Layer;createPie(iolayer,150,150,"up_total","upShare","Upload");createPie(iolayer,400,150,"down_total","downShare","Download");createPie(iolayer,650,160,"ratio","ratioShare","Ratio");iostage.add(iolayer)}
function createPie(a,b,c,d,f,h){var k=[],g=b+100,m=c,n=0,l=0,r="rgb(0,0,0) rgb(0,0,255) rgb(0,255,0) rgb(255,0,0) rgb(0,255,255) rgb(255,0,255) rgb(255,255,0) rgb(150,0,0) rgb(0,150,0) rgb(0,0,150) rgb(0,150,150) rgb(150,0,150) rgb(150,150,0) rgb(150,150,150)".split(" "),q=0,p;for(p in trackerData)if(trackerData.hasOwnProperty(p)){var e={};e.title=h;e.strokeStyle=r[q];e.fillStyle=r[q];e.startA=n;e.originX=b;e.originY=c;e.radius=100;data=trackerData[p];e.tracker=p;e.favicon=data.favicon;e.tot=data[d];
upshare=data[f];e.share=upshare;l=n+upshare*Math.PI*2;e.endA=l;e.startX=g;e.startY=m;halfPos=calcHalfPos(n,b,c,100);e.startHalfX=halfPos[0];e.startHalfY=halfPos[1];endhalfPos=calcHalfPos(l,b,c,100);e.endHalfX=endhalfPos[0];e.endHalfY=endhalfPos[1];endPos=calcHalfPos(l,b,c,100,1);g=endPos[0];m=endPos[1];e.endX=endPos[0];e.endY=endPos[1];n=l;obj=drawShape(e);pieSlices[obj.attrs.fill+"."+b]=e;obj.on("mouseover",function(a){if(50<=a.layerX&&250>=a.layerX)var b=".150";else 300<=a.layerX&&500>=a.layerX?
b=".400":550<=a.layerX&&750>=a.layerX&&(b=".650");this.setStroke("black");this.attrs.strokeWidth=3;iolayer.draw();pieToolTip(this,pieSlices[this.attrs.fill+b])});obj.on("mouseout",function(a){this.setStroke(this.attrs.fill);this.attrs.strokeWidth=1;iolayer.draw()});k.push(obj);q++;a.add(obj);tex=labelShape(e);a.add(tex)}}function nearestBoundary(a){var b=[25,275,525,775],c=[];for(i=0;i<b.length;i++)c.push(Math.abs(a-b[i]));mindiff=Math.min.apply(Math,c);idx=c.indexOf(mindiff);return b[idx]}
function tagText(a,b,c){return new Kinetic.Text({text:c,x:a,y:b,fontSize:12,fontFamily:"Trebuchet MS",textFill:"black",fontStyle:"bold",align:"left"})}function labelText(a,b,c){return new Kinetic.Text({text:c,x:a,y:b,fontSize:12,fontFamily:"Trebuchet MS",textFill:"black",align:"left"})}function destroyPieTool(a){null!==tiplayer&&(iostage.remove(tiplayer),tiplayer=null)}
function pieToolTip(a,b){theta1=b.startA;theta2=b.endA;angle=theta1+(theta2-theta1)/2;startPos=calcHalfPos(angle,b.originX,b.originY,b.radius,1);endPos=calcHalfPos(angle,b.originX,b.originY,b.radius,1.1);xboundary=nearestBoundary(endPos[0]);25==xboundary?(xlb=10,xrb=360):775==xboundary?(xlb=440,xrb=790):(xlb=xboundary-175,xrb=xboundary+175);var c=new Kinetic.Line({points:[startPos[0],startPos[1],endPos[0],endPos[1],xboundary,endPos[1],xboundary,300,xlb,300,xlb,410,xrb,410,xrb,300,xboundary,300],stroke:b.strokeStyle,
strokeWidth:4,lineCap:"round"});null!==tiplayer&&iostage.remove(tiplayer);tiplayer=new Kinetic.Layer;var d=new Image;d.onload=function(){var a=new Kinetic.Image({x:xrb-10,y:292,image:d,width:20,height:20});a.on("click",destroyPieTool);tiplayer.add(a);tiplayer.draw()};d.src="images/remove.png";var f=new Image;f.onload=function(){var a=new Kinetic.Image({x:xlb+10,y:310,image:f,width:16,height:16});tiplayer.add(a)};f.src=b.favicon;var h=new Image;h.onload=function(){var a=new Kinetic.Image({x:xlb+10,
y:335,image:h,width:16,height:16});tiplayer.add(a);tiplayer.draw()};h.src="images/up_icon.gif";var k=new Image;k.onload=function(){var a=new Kinetic.Image({x:xlb+10,y:360,image:k,width:16,height:16});tiplayer.add(a);tiplayer.draw()};k.src="images/down_icon.gif";var g=new Image;g.onload=function(){var a=new Kinetic.Image({x:xlb+10,y:385,image:g,width:16,height:16});tiplayer.add(a);tiplayer.draw()};g.src="images/ratio.jpg";var m=new Kinetic.Text({text:"Stats for "+b.tracker,x:xlb+36,y:311,fontSize:13,
fontFamily:"Trebuchet MS",textFill:"black",fontStyle:"bold",align:"left"});tiplayer.add(tagText(xlb+36,336,"Upload: "));tiplayer.add(labelText(xlb+130,336,trackerData[b.tracker].up_total+" ("+Math.round(100*trackerData[b.tracker].upShare)+"%)"));tiplayer.add(tagText(xlb+36,361,"Download: "));tiplayer.add(labelText(xlb+130,361,trackerData[b.tracker].down_total+" ("+Math.round(100*trackerData[b.tracker].downShare)+"%)"));tiplayer.add(tagText(xlb+36,386,"Ratio: "));tiplayer.add(labelText(xlb+130,386,
Math.round(100*trackerData[b.tracker].ratio)/100+" ("+Math.round(100*trackerData[b.tracker].ratioShare)+"%)"));tiplayer.add(c);tiplayer.add(m);iostage.add(tiplayer);tiplayer.draw()}function labelShape(a){return new Kinetic.Text({x:a.originX,y:a.originY-7,text:a.title,fontSize:14,fontFamily:"Trebuchet MS",textFill:"black",align:"center"})}
function drawShape(a){return new Kinetic.Shape({drawFunc:function(){var b=this.getContext("2d");b.beginPath();b.moveTo(a.startHalfX,a.startHalfY);b.lineTo(a.startX,a.startY);b.arc(a.originX,a.originY,a.radius,a.startA,a.endA,!1);b.moveTo(a.endX,a.endY);b.lineTo(a.endHalfX,a.endHalfY);b.arc(a.originX,a.originY,a.radius/2,a.endA,a.startA,!0);b.fill();this.applyStyles()},fill:a.fillStyle,stroke:a.strokeStyle,strokeWidth:1})}
function calcHalfPos(a,b,c,d,f){void 0==f&&(f=.5);halfPosY=halfPosX=null;a<=Math.PI/2?(halfPosX=b+d*f*Math.cos(a),halfPosY=c+d*f*Math.sin(a)):a>Math.PI/2&&a<=Math.PI?(halfPosX=b-d*f*Math.sin(a-Math.PI/2),halfPosY=c+d*f*Math.cos(a-Math.PI/2)):a>Math.PI&&a<=3*Math.PI/2?(halfPosX=b-d*f*Math.cos(a-Math.PI),halfPosY=c-d*f*Math.sin(a-Math.PI)):a>3*Math.PI/2&&(halfPosX=b+d*f*Math.sin(a-3*Math.PI/2),halfPosY=c-d*f*Math.cos(a-3*Math.PI/2));return[halfPosX,halfPosY]}
function initGraph(){cHeight=parseInt($("#canvas-net").height());cWidth=parseInt($("#canvas-net").width());cOriginX=xoffset;cOriginY=cHeight-nyoffset;eHeight=cOriginY-yoffset;eWidth=cWidth-xoffset-nxoffset;maxValues=Math.floor(eWidth/2);clearCanvas($("#canvas-net"));netctx=document.getElementById("canvas-net").getContext("2d");sysctx=document.getElementById("canvas-system").getContext("2d");drawAxes(netctx);drawAxes(sysctx);drawLegend(netctx,["Upload","Download"]);drawLegend(sysctx,["Load Avg","Memory",
"HDD"])}function _drawLegendItem(a,b,c,d,f){a.fillStyle=f;a.beginPath();a.moveTo(c,d);a.lineTo(c+(nxoffset-5),d);a.lineTo(c+(nxoffset-5),d+10);a.lineTo(c,d+10);a.lineTo(c,d);a.fill();a.closePath();a.fillText(b,c,d+20)}function drawLegend(a,b){styles=["rgb(255,0,0)","rgb(0,0,255)","rgb(0,255,0)"];for(i=0;i<b.length;i++)startX=cWidth-(nxoffset-5),startY=30*(i+1)+xoffset,_drawLegendItem(a,b[i],startX,startY,styles[i])}
function drawAxes(a){a.strokeStyle="rgb(0,0,0)";a.fillStyle="rgb(0,0,0)";a.beginPath();a.moveTo(cOriginX,yoffset);a.lineTo(cOriginX,cOriginY);a.lineTo(cWidth-nxoffset,cOriginY);a.stroke();a.closePath();a.beginPath();a.moveTo(cOriginX,yoffset);a.lineTo(cOriginX-5,yoffset);a.lineTo(cOriginX,yoffset-5);a.lineTo(cOriginX+5,yoffset);a.lineTo(cOriginX,yoffset);a.fill();a.closePath();a.beginPath();strtx=cWidth-nxoffset;a.moveTo(strtx,cOriginY);a.lineTo(strtx,cOriginY-5);a.lineTo(strtx+5,cOriginY);a.lineTo(strtx,
cOriginY+5);a.lineTo(strtx,cOriginY);a.fill();a.closePath()}function getScaleFactor(){allData=UpData.concat(DownData);allMax=Math.max.apply(Math,allData);return scaleF=allMax/eHeight}function getLoadSF(){max=Math.max.apply(Math,LoadData);return scaleF=max/eHeight}function getMemSF(){return scaleF=MemTotal/eHeight}function getHDDSF(){return scaleF=HddTotal/eHeight}
function drawFilledDataLine(a,b,c,d,f){a.beginPath();a.strokeStyle=d;a.fillStyle=f;startY=eHeight-c[0]/b+yoffset+1;a.moveTo(cOriginX+1,startY);for(i=0;i<c.length;i++)pos_y=eHeight-c[i]/b+yoffset,a.lineTo(cOriginX+2*i+1,pos_y);a.stroke();a.lineTo(cOriginX+2*i,eHeight-1+yoffset);a.lineTo(cOriginX+1,eHeight-1+yoffset);a.lineTo(cOriginX+1,startY);a.closePath();a.fill()}
function drawDataLine(a,b,c,d){a.beginPath();a.strokeStyle=d;startY=eHeight-c[0]/b+yoffset+1;a.moveTo(cOriginX+1,startY);for(i=0;i<c.length;i++)pos_y=eHeight-c[i]/b+yoffset,a.lineTo(cOriginX+2*i+1,pos_y);a.stroke();a.closePath()}
function update_canvas(){netctx.clearRect(0,0,cWidth-nxoffset,cHeight);sysctx.clearRect(0,0,cWidth-nxoffset,cHeight);drawAxes(netctx);drawAxes(sysctx);scale_factor=getScaleFactor();drawFilledDataLine(sysctx,getMemSF(),MemData,"rgb(0,0,255)","rgba(0,0,255,0.2)");drawFilledDataLine(sysctx,getHDDSF(),HddData,"rgb(0,255,0)","rgba(0,255,0,0.2)");drawDataLine(sysctx,getLoadSF(),LoadData,"rgb(255,0,0)");drawDataLine(netctx,scale_factor,UpData,"rgb(255,0,0)");drawDataLine(netctx,scale_factor,DownData,"rgb(0,0,255)")}
function clearCanvas(){$(netctx).attr("width",$(netctx).attr("width"))}function init(){StatSocket.send("request=trackers");mainLoop()}
function onMessage(a){if(-1!==a.data.indexOf("ERROR"))return $("#status-div").removeClass("status-ok status-bad").addClass("status-bad").html("StatSocket ERROR: "+a.data.split("ERROR/")[1]),!1;if("pong"!=a.data)return data=JSON.parse(a.data),"trackers"==data.type?(trackerData=data.data,initTGraph()):"global"==data.type&&($("#status-uprate").html("<div class='status-label status-system'>Upload rate:</div><div class='status-uprate-value status-value'>"+data.uprate_str+"/s</div>"),$("#status-downrate").html("<div class='status-label status-system'>Download rate:</div><div class='status-downrate-value status-value'>"+
data.downrate_str+"/s</div>"),$("#status-loadavg").html("<div class='status-label status-system'>Load average:</div><div class='status-loadavg-value status-value'>"+data.loadavg+"</div>"),$("#status-mem").html("<div class='status-label status-system'>Memory usage:</div><div class='status-mem-value status-value'>"+data.memperc+"% ("+data.memusage_human+" / "+data.memmax_human+")</div>"),$("#status-hdd").html("<div class='status-label status-system'>HDD usage:</div><div class='status-hdd-value status-value'>"+
data.hdperc+"% ("+data.hdusage_human+" / "+data.hdmax_human+")</div>"),HddTotal=data.hdmax,MemTotal=data.memmax,UpData.push(data.uprate)>maxValues&&UpData.shift(),DownData.push(data.downrate)>maxValues&&DownData.shift(),LoadData.push(data.loadavg)>maxValues&&LoadData.shift(),MemData.push(data.memusage)>maxValues&&MemData.shift(),HddData.push(data.hdusage)>maxValues&&HddData.shift(),60>UpData.length?$("#canvas-title-dynamic").html("(Last "+UpData.length+" seconds)"):(mins=Math.floor(UpData.length/
60),secs=UpData.length%60,mins=1==mins?"Last minute":"Last "+mins+" minutes",secs=0==secs?"":" and "+secs+" seconds",$("#canvas-title-dynamic").html("("+mins+secs+")")),update_canvas()),!1}function onOpen(a){console.log("StatSocket opened",a,StatSocket);initGraph();init()}function onClose(a){console.log("StatSocket closed",a,StatSocket)}function onError(a){console.log("StatSocket Error",a,StatSocket)};
