var StatSocket=null;var UpData=new Array();var DownData=new Array();var LoadData=new Array();var MemData=new Array();var MemTotal=null;var HddData=new Array();var HddTotal=null;var HddFirst=null;var netctx=null;var sysctx=null;var iolayer=null;var tiplayer=null;var iostage=null;var cHeight=null;var cWidth=null;var cOriginX=null;var cOriginY=null;var eHeight=null;var eWidth=null;var xoffset=5;var yoffset=6;var nxoffset=55;var nyoffset=10;var maxValues=null;var trackerData=null;var pieSlices=new Object();if(window.document.location.protocol=="https:")var socket_protocol="wss";else var socket_protocol="ws";$(document).ready(function(){StatSocket=new WebSocket(socket_protocol+"://"+window.document.location.host+"/statsocket");StatSocket.onmessage=onMessage;StatSocket.onopen=onOpen;StatSocket.onclose=onClose;StatSocket.onerror=onError;});function mainLoop(){StatSocket.send("request=global");setTimeout(mainLoop,1000);}function initTGraph(){clearCanvas($("#canvas-io"));iostage=new Kinetic.Stage({container:"canvas-io",width:800,height:420});iolayer=new Kinetic.Layer();createPie(iolayer,150,150,"up_total","upShare","Upload");createPie(iolayer,400,150,"down_total","downShare","Download");createPie(iolayer,650,160,"ratio","ratioShare","Ratio");iostage.add(iolayer);}function createPie(a,b,c,d,e,f){var g=new Array();var h=b;var i=c;var j=h+100;var k=i;var l=0;var m=0;var n=100;var o=["rgb(0,0,0)","rgb(0,0,255)","rgb(0,255,0)","rgb(255,0,0)","rgb(0,255,255)","rgb(255,0,255)","rgb(255,255,0)","rgb(150,0,0)","rgb(0,150,0)","rgb(0,0,150)","rgb(0,150,150)","rgb(150,0,150)","rgb(150,150,0)","rgb(150,150,150)"];var p=0;for(var q in trackerData)if(trackerData.hasOwnProperty(q)){var r=new Object();r.title=f;r.strokeStyle=o[p];r.fillStyle=o[p];r.startA=l;r.originX=h;r.originY=i;r.radius=n;data=trackerData[q];r.tracker=q;r.favicon=data.favicon;r.tot=data[d];upshare=data[e];r.share=upshare;m=l+(upshare*Math.PI*2);r.endA=m;r.startX=j;r.startY=k;halfPos=calcHalfPos(l,h,i,n);r.startHalfX=halfPos[0];r.startHalfY=halfPos[1];endhalfPos=calcHalfPos(m,h,i,n);r.endHalfX=endhalfPos[0];r.endHalfY=endhalfPos[1];endPos=calcHalfPos(m,h,i,n,1.0);j=endPos[0];k=endPos[1];r.endX=endPos[0];r.endY=endPos[1];l=m;obj=drawShape(r);pieSlices[obj.attrs.fill+"."+h]=r;obj.on("mouseover",function(a){if(a.layerX>=50&&a.layerX<=250)var b=".150";else if(a.layerX>=300&&a.layerX<=500)var b=".400";else if(a.layerX>=550&&a.layerX<=750)var b=".650";this.setStroke("black");this.attrs.strokeWidth=3;iolayer.draw();pieToolTip(this,pieSlices[this.attrs.fill+b]);});obj.on("mouseout",function(a){this.setStroke(this.attrs.fill);this.attrs.strokeWidth=1;iolayer.draw();});g.push(obj);p++;a.add(obj);tex=labelShape(r);a.add(tex);}}function nearestBoundary(a){var b=[25,275,525,775];var c=new Array();for(i=0;i<b.length;i++)c.push(Math.abs(a-b[i]));mindiff=Math.min.apply(Math,c);idx=c.indexOf(mindiff);return b[idx];}function tagText(a,b,c){var d=new Kinetic.Text({text:c,x:a,y:b,fontSize:12,fontFamily:"Trebuchet MS",textFill:"black",fontStyle:"bold",align:"left"});return d;}function labelText(a,b,c){var d=new Kinetic.Text({text:c,x:a,y:b,fontSize:12,fontFamily:"Trebuchet MS",textFill:"black",align:"left"});return d;}function destroyPieTool(a){if(tiplayer!==null){iostage.remove(tiplayer);tiplayer=null;}}function pieToolTip(a,b){theta1=b.startA;theta2=b.endA;angle=theta1+(theta2-theta1)/2;startPos=calcHalfPos(angle,b.originX,b.originY,b.radius,1.0);endPos=calcHalfPos(angle,b.originX,b.originY,b.radius,1.1);xboundary=nearestBoundary(endPos[0]);if(xboundary==25){xlb=10;xrb=360;}else if(xboundary==775){xlb=440;xrb=790;}else{xlb=xboundary-175;xrb=xboundary+175;}var c=new Kinetic.Line({points:[startPos[0],startPos[1],endPos[0],endPos[1],xboundary,endPos[1],xboundary,300,xlb,300,xlb,410,xrb,410,xrb,300,xboundary,300],stroke:b.strokeStyle,strokeWidth:4,lineCap:"round"});if(tiplayer!==null)iostage.remove(tiplayer);tiplayer=new Kinetic.Layer();var d=new Image();d.onload=function(){var a=new Kinetic.Image({x:xrb-10,y:292,image:d,width:20,height:20});a.on("click",destroyPieTool);tiplayer.add(a);tiplayer.draw();};d.src="/images/remove.png";var e=new Image();e.onload=function(){var a=new Kinetic.Image({x:xlb+10,y:310,image:e,width:16,height:16});tiplayer.add(a);};e.src=b.favicon;var f=new Image();f.onload=function(){var a=new Kinetic.Image({x:xlb+10,y:335,image:f,width:16,height:16});tiplayer.add(a);tiplayer.draw();};f.src="/images/up_icon.gif";var g=new Image();g.onload=function(){var a=new Kinetic.Image({x:xlb+10,y:360,image:g,width:16,height:16});tiplayer.add(a);tiplayer.draw();};g.src="/images/down_icon.gif";var h=new Image();h.onload=function(){var a=new Kinetic.Image({x:xlb+10,y:385,image:h,width:16,height:16});tiplayer.add(a);tiplayer.draw();};h.src="/images/ratio.jpg";var i=new Kinetic.Text({text:"Stats for "+b.tracker,x:xlb+36,y:311,fontSize:13,fontFamily:"Trebuchet MS",textFill:"black",fontStyle:"bold",align:"left"});tiplayer.add(tagText(xlb+36,336,"Upload: "));tiplayer.add(labelText(xlb+130,336,trackerData[b.tracker].up_total+" ("+Math.round(trackerData[b.tracker].upShare*100)+"%)"));tiplayer.add(tagText(xlb+36,361,"Download: "));tiplayer.add(labelText(xlb+130,361,trackerData[b.tracker].down_total+" ("+Math.round(trackerData[b.tracker].downShare*100)+"%)"));tiplayer.add(tagText(xlb+36,386,"Ratio: "));tiplayer.add(labelText(xlb+130,386,Math.round(trackerData[b.tracker].ratio*100)/100+" ("+Math.round(trackerData[b.tracker].ratioShare*100)+"%)"));tiplayer.add(c);tiplayer.add(i);iostage.add(tiplayer);tiplayer.draw();}function labelShape(a){var b=new Kinetic.Text({x:a.originX,y:a.originY-7,text:a.title,fontSize:14,fontFamily:"Trebuchet MS",textFill:"black",align:"center"});return b;}function drawShape(a){var b=new Kinetic.Shape({drawFunc:function(){var b=this.getContext("2d");b.beginPath();b.moveTo(a.startHalfX,a.startHalfY);b.lineTo(a.startX,a.startY);b.arc(a.originX,a.originY,a.radius,a.startA,a.endA,false);b.moveTo(a.endX,a.endY);b.lineTo(a.endHalfX,a.endHalfY);b.arc(a.originX,a.originY,a.radius/2,a.endA,a.startA,true);b.fill();this.applyStyles();},fill:a.fillStyle,stroke:a.strokeStyle,strokeWidth:1});return b;}function calcHalfPos(a,b,c,d,e){if(e==undefined)e=0.5;halfPosX=null;halfPosY=null;if(a<=Math.PI/2){halfPosX=b+(d*e)*Math.cos(a);halfPosY=c+(d*e)*Math.sin(a);}else if(a>Math.PI/2&&a<=Math.PI){halfPosX=b-(d*e)*Math.sin(a-Math.PI/2);halfPosY=c+(d*e)*Math.cos(a-Math.PI/2);}else if(a>Math.PI&&a<=3*Math.PI/2){halfPosX=b-(d*e)*Math.cos(a-Math.PI);halfPosY=c-(d*e)*Math.sin(a-Math.PI);}else if(a>3*Math.PI/2){halfPosX=b+(d*e)*Math.sin(a-3*Math.PI/2);halfPosY=c-(d*e)*Math.cos(a-3*Math.PI/2);}return new Array(halfPosX,halfPosY);}function initGraph(){cHeight=parseInt($("#canvas-net").height());cWidth=parseInt($("#canvas-net").width());cOriginX=xoffset;cOriginY=cHeight-nyoffset;eHeight=cOriginY-yoffset;eWidth=cWidth-xoffset-nxoffset;maxValues=Math.floor(eWidth/2);clearCanvas($("#canvas-net"));var a=document.getElementById("canvas-net");netctx=a.getContext("2d");var b=document.getElementById("canvas-system");sysctx=b.getContext("2d");drawAxes(netctx);drawAxes(sysctx);drawLegend(netctx,new Array("Upload","Download"));drawLegend(sysctx,new Array("Load Avg","Memory","HDD"));}function _drawLegendItem(a,b,c,d,e){a.fillStyle=e;a.beginPath();a.moveTo(c,d);a.lineTo(c+(nxoffset-5),d);a.lineTo(c+(nxoffset-5),d+10);a.lineTo(c,d+10);a.lineTo(c,d);a.fill();a.closePath();a.fillText(b,c,d+20);}function drawLegend(a,b){styles=new Array("rgb(255,0,0)","rgb(0,0,255)","rgb(0,255,0)");for(i=0;i<b.length;i++){startX=cWidth-(nxoffset-5);startY=30*(i+1)+xoffset;_drawLegendItem(a,b[i],startX,startY,styles[i]);}}function drawAxes(a){a.strokeStyle="rgb(0,0,0)";a.fillStyle="rgb(0,0,0)";a.beginPath();a.moveTo(cOriginX,yoffset);a.lineTo(cOriginX,cOriginY);a.lineTo(cWidth-nxoffset,cOriginY);a.stroke();a.closePath();a.beginPath();a.moveTo(cOriginX,yoffset);a.lineTo(cOriginX-5,yoffset);a.lineTo(cOriginX,yoffset-5);a.lineTo(cOriginX+5,yoffset);a.lineTo(cOriginX,yoffset);a.fill();a.closePath();a.beginPath();strtx=cWidth-nxoffset;a.moveTo(strtx,cOriginY);a.lineTo(strtx,cOriginY-5);a.lineTo(strtx+5,cOriginY);a.lineTo(strtx,cOriginY+5);a.lineTo(strtx,cOriginY);a.fill();a.closePath();}function getScaleFactor(){allData=UpData.concat(DownData);allMax=Math.max.apply(Math,allData);scaleF=allMax/eHeight;return scaleF;}function getLoadSF(){max=Math.max.apply(Math,LoadData);scaleF=max/eHeight;return scaleF;}function getMemSF(){scaleF=MemTotal/eHeight;return scaleF;}function getHDDSF(){scaleF=HddTotal/eHeight;return scaleF;}function drawFilledDataLine(a,b,c,d,e){a.beginPath();a.strokeStyle=d;a.fillStyle=e;startY=eHeight-(c[0]/b)+yoffset+1;a.moveTo(cOriginX+1,startY);for(i=0;i<c.length;i++){pos_y=eHeight-(c[i]/b)+yoffset;a.lineTo(cOriginX+i*2+1,pos_y);}a.stroke();a.lineTo(cOriginX+i*2,eHeight-1+yoffset);a.lineTo(cOriginX+1,eHeight-1+yoffset);a.lineTo(cOriginX+1,startY);a.closePath();a.fill();}function drawDataLine(a,b,c,d){a.beginPath();a.strokeStyle=d;startY=eHeight-(c[0]/b)+yoffset+1;a.moveTo(cOriginX+1,startY);for(i=0;i<c.length;i++){pos_y=eHeight-(c[i]/b)+yoffset;a.lineTo(cOriginX+i*2+1,pos_y);}a.stroke();a.closePath();}function update_canvas(){netctx.clearRect(0,0,cWidth-nxoffset,cHeight);sysctx.clearRect(0,0,cWidth-nxoffset,cHeight);drawAxes(netctx);drawAxes(sysctx);scale_factor=getScaleFactor();drawFilledDataLine(sysctx,getMemSF(),MemData,"rgb(0,0,255)","rgba(0,0,255,0.2)");drawFilledDataLine(sysctx,getHDDSF(),HddData,"rgb(0,255,0)","rgba(0,255,0,0.2)");drawDataLine(sysctx,getLoadSF(),LoadData,"rgb(255,0,0)");drawDataLine(netctx,scale_factor,UpData,"rgb(255,0,0)");drawDataLine(netctx,scale_factor,DownData,"rgb(0,0,255)");}function clearCanvas(){$(netctx).attr("width",$(netctx).attr("width"));}function init(){StatSocket.send("request=trackers");mainLoop();}function onMessage(a){if(a.data.indexOf("ERROR")!==-1){$("#status-div").removeClass("status-ok status-bad").addClass("status-bad").html("StatSocket ERROR: "+a.data.split("ERROR/")[1]);return false;}else{data=JSON.parse(a.data);if(data.type=="trackers"){trackerData=data.data;initTGraph();}else if(data.type=="global"){$("#status-uprate").html("<div class='status-label status-system'>Upload rate:</div><div class='status-uprate-value status-value'>"+data.uprate_str+"/s</div>");$("#status-downrate").html("<div class='status-label status-system'>Download rate:</div><div class='status-downrate-value status-value'>"+data.downrate_str+"/s</div>");$("#status-loadavg").html("<div class='status-label status-system'>Load average:</div><div class='status-loadavg-value status-value'>"+data.loadavg+"</div>");$("#status-mem").html("<div class='status-label status-system'>Memory usage:</div><div class='status-mem-value status-value'>"+data.memperc+"% ("+data.memusage_human+" / "+data.memmax_human+")</div>");$("#status-hdd").html("<div class='status-label status-system'>HDD usage:</div><div class='status-hdd-value status-value'>"+data.hdperc+"% ("+data.hdusage_human+" / "+data.hdmax_human+")</div>");HddTotal=data.hdmax;MemTotal=data.memmax;if(UpData.push(data.uprate)>maxValues)UpData.shift();if(DownData.push(data.downrate)>maxValues)DownData.shift();if(LoadData.push(data.loadavg)>maxValues)LoadData.shift();if(MemData.push(data.memusage)>maxValues)MemData.shift();if(HddData.push(data.hdusage)>maxValues)HddData.shift();if(UpData.length<60)$("#canvas-title-dynamic").html("(Last "+UpData.length+" seconds)");else{mins=Math.floor(UpData.length/60);secs=UpData.length%60;if(mins==1)mins="Last minute";else mins="Last "+mins+" minutes";if(secs==0)secs="";else secs=" and "+secs+" seconds";$("#canvas-title-dynamic").html("("+mins+secs+")");}update_canvas();}return false;}}function onOpen(a){console.log("StatSocket opened",a,StatSocket);initGraph();init();}function onClose(a){console.log("StatSocket closed",a,StatSocket);}function onError(a){console.log("StatSocket Error",a,StatSocket);}