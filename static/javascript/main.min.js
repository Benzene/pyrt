var CTRL_SELECTED=!1,SELECTED=[],statusArrayInactive=["Stopped","Paused"],statusArrayActive=["Seeding (idle)","Seeding","Leeching (idle)","Leeching","Hashing"],DELETING=[],DROP_OPEN=[],ws=null,dragOverlayOpen=null,dragOverlayCreated=null,socket_protocol="https:"==window.document.location.protocol?"wss":"ws",refresh_rate=5E3;
$(document).ready(function(){setTimeout(function(){refresh_content("yes")},refresh_rate);ws=new window.WebSocket(socket_protocol+"://"+window.document.location.host+window.document.location.pathname+"ajaxsocket");ws.onmessage=messageHandler;ws.onclose=function(a){};ws.onopen=function(a){ws.send("request=get_refresh_rate")};ws.onerror=function(a){console.log("WebSocket error",ws,a)};6E4>refresh_rate&&setInterval(function(){ws.send("ping")},4E4);$("#add-torrent-button").click(function(){$("#add_torrent").dialog("open")});
$("#add_torrent").dialog({height:220,width:420,modal:!0,autoOpen:!1,buttons:{"Add torrent":function(){$("#add_torrent_input").val()?$("#add_torrent_form").submit():$("#add_torrent_form").css("border","1px solid red")},Cancel:function(){$(this).dialog("close")}}});loadRClickMenus();$("body").bind("dragenter",function(a){500<(new Date).getTime()-dragOverlayCreated&&createDragOverlay();a.preventDefault();a.stopPropagation();return!1}).bind("dragleave",function(a){500<(new Date).getTime()-dragOverlayCreated&&
destroyDragOverlay();a.preventDefault();a.stopPropagation();return!1}).bind("dragover",function(a){a.preventDefault()}).bind("drop",function(a){a.preventDefault();console.log("drop handler called");a.stopPropagation();var b=a.originalEvent.dataTransfer.files,c=[];0<b.length?(fs=new window.WebSocket(socket_protocol+"://"+window.document.location.host+window.document.location.pathname+"filesocket"),fs.onmessage=function(a){resp=JSON.parse(a.data);"OK"==resp.response?$("#dragOverlayDialog-file-"+resp.id).removeClass("dragOverlayDialog-file-pending").addClass("dragOverlayDialog-file-ok"):
$("#dragOverlayDialog-file-"+resp.id).removeClass("dragOverlayDialog-file-pending").addClass("dragOverlayDialog-file-bad").html(resp.filename+" upload failed: "+resp.response);c.splice(c.indexOf(resp.id),1);0==c.length&&(fs.close(),destroyDragOverlay())},fs.onclose=function(a){},fs.onopen=function(a){for(i=0;i<b.length;i++)if("application/x-bittorrent"==b[i].type||""==b[i].type){a=Math.random().toString(36).substr(2,5);$("<div id='dragOverlayDialog-file-"+a+"'>").addClass("dragOverlayDialog-file-pending").html("<span class='dragOverlayDialog-filename'>"+
b[i].name+"</span> uploaded").appendTo("#dragOverlayDialog");var f=new FileReader;c.push(a);f.onload=function(a,b){return function(c){console.log(c);fs.send("FILENAME@@@"+a.name+":::ID@@@"+b+":::CONTENT@@@"+c.target.result)}}(b[i],a);f.onerror=function(a){};f.readAsDataURL(b[i])}else $("<div />").addClass("dragOverlayDialog-file-bad").html(b[i].name+" ignored").appendTo("#dragOverlayDialog")},fs.onerror=function(a){console.log("WebSocket error",ws,a)}):destroyDragOverlay();return!1});$(document).keydown(function(a){!a.ctrlKey&&
91!=a.which||CTRL_SELECTED||(CTRL_SELECTED=!0,$("#torrent_table").selectable({filter:".torrent-div",tolerance:"touch"}),$("body").css({cursor:"copy"}),a.preventDefault(),a.stopPropagation())});$(document).keyup(function(a){if(17==a.which||91==a.which&&CTRL_SELECTED)CTRL_SELECTED=!1,$("#torrent_table").selectable("destroy"),$("body").css("cursor","")});$(".torrent-div").live("click",function(a){$(a.target).is("img")||a.ctrlKey||(torrent_id=$(a.target).parent().attr("id").split("torrent_id_")[1],-1==
$.inArray(torrent_id,DROP_OPEN)?drop_down(this):drop_up(torrent_id))});$(".batch-control").live("click",function(a){action=this.id.split("batch-")[1];torrentIDs=[];for(i=0;i<SELECTED.length;i++)torrentIDs.push(SELECTED[i].split("torrent_id_")[1]);"delete"==action?($("#delete_targets").empty(),sendme="request=delete_query_batch&torrentIDs="+torrentIDs.join(",")):("remove"==action&&(SELECTED=[],destroyBatchActionBox()),sendme="request="+action+"_batch",sendme=sendme+"&torrentIDs="+torrentIDs.join(","));
ws.send(sendme)});$("#batch-deselect").live("click",function(a){for(i=0;i<SELECTED.length;i++)torrent=$("#"+SELECTED[i]),torrent.css({"background-color":""}),torrent.removeClass("ui-selected ui-selecting");SELECTED=[];destroyBatchActionBox()});$("#torrent_table").live("selectableselected",function(a,b){select_group_torrent(b.selected,a)}).live("selectableunselected",function(a,b){deselect_group_torrent(b.unselected,a)}).live("selectableselecting",function(a,b){-1==SELECTED.indexOf(b.selecting.id)&&
$(b.selecting).css({"background-color":"#d9ffd9"})}).live("selectableunselecting",function(a,b){-1==SELECTED.indexOf(b.unselecting.id)&&$(b.unselecting).css({"background-color":""})});$(".control_start_me").live("click",function(a){torrent_id=$(this).parents(".torrent-div").attr("id").split("torrent_id_")[1];command("start_torrent",torrent_id);return!1});$(".control_pause_me").live("click",function(a,b){torrent_id=$(this).parents(".torrent-div").attr("id").split("torrent_id_")[1];command("pause_torrent",
torrent_id);return!1});$(".control_stop_me").live("click",function(a){torrent_id=$(this).parents(".torrent-div").attr("id").split("torrent_id_")[1];command("stop_torrent",torrent_id);return!1});$(".control_remove_me").live("click",function(a){torrent_id=$(this).parents(".torrent-div").attr("id").split("torrent_id_")[1];command("remove_torrent",torrent_id);return!1});$(".control_delete_me").live("click",function(a){torrent_id=$(this).parents(".torrent-div").attr("id").split("torrent_id_")[1];command("delete_query",
torrent_id);return!1});$(".download.allowed").live("click",function(a){a=$(this).next().next().text();var b=$(this).closest(".drop_down_container").attr("id").split("drop_down_container_")[1];ws.send("request=download_file&torrentID="+b+"&path="+encodeURIComponent(a))});$("#delete_confirmation").dialog({resizable:!0,height:"auto",width:"auto",modal:!0,buttons:{Delete:function(){var a=$(this).attr("data-torrent_id");$("#torrent_id_"+a).addClass("deleting-torrent-row").removeClass("blue green");DELETING.push(a);
$(this).attr("data-torrent_id",null);$(this).dialog("close");ws.send("request=delete_torrent&torrent_id="+a+"&confirmation=true")},Cancel:function(){$(this).dialog("close")}},autoOpen:!1});$("#delete_confirmation_batch").dialog({resizable:!0,height:"auto",width:"auto",modal:!0,buttons:{Delete:function(){torrentIDs=[];for(i=0;i<SELECTED.length;i++){var a=SELECTED[i].split("torrent_id_")[1];torrentIDs.push(a);$("#"+SELECTED[i]).addClass("deleting-torrent-row").removeClass("blue green ui-selected ui-selecting").css({"background-color":""});
DELETING.push(a)}SELECTED=[];destroyBatchActionBox();sendme="request=delete_batch&torrentIDs="+torrentIDs.join(",");ws.send(sendme);$(this).dialog("close")},Cancel:function(){$(this).dialog("close")}},autoOpen:!1})});function select_group_torrent(a,b){sel_index=SELECTED.indexOf(a.id);-1===sel_index&&(SELECTED.push(a.id),a.style.backgroundColor="#AEC798",1==SELECTED.length&&createBatchActionBox(b.pageX,b.pageY))}
function deselect_group_torrent(a,b){sel_index=SELECTED.indexOf(a.id);-1!=sel_index&&(SELECTED.splice(sel_index,1),$(a).css({"background-color":""}),0==SELECTED.length&&destroyBatchActionBox())}
function createBatchActionBox(a,b){batchActionsBox=$("<div id='batchActionBox'></div>");head=$("<div id='batch-head' class='heading'>Batch Action</div>");start=$("<img class='batch-control' id='batch-start' src='../images/start.png' title='Start Batch'>");pause=$("<img class='batch-control' id='batch-pause' src='../images/pause.png' title='Pause Batch'>");stop=$("<img class='batch-control' id='batch-stop' src='../images/stop.png' title='Stop Batch'>");startpausestop=$("<div id='batch-control-row1'></div>").append(start,
pause,stop);remove=$("<img class='batch-control' id='batch-remove' src='../images/remove.png' title='Remove Batch'>");del=$("<img class='batch-control' id='batch-delete' src='../images/delete.png' title='Delete Batch'>");startpausestop.append(remove,del);deselect=$("<div id='batch-deselect'>Deselect all</div>");controls=$("<div id='batch-controls'></div>").append(startpausestop,deselect);newElem=batchActionsBox.append(head,controls);$("body").append(newElem);$("#batchActionBox").animate({left:"0px"},
200)}function destroyBatchActionBox(){$("#batchActionBox").remove()}function stripeTable(){var a=["blue","green"];$(".torrent-div").each(function(){col=a.shift();$(this).removeClass("blue green");$(this).addClass(col);a.push(col)})}
function loadRClickMenus(){$(".torrent-div.rcstart").contextMenu("right_click_start",{bindings:{start:function(a){a=a.id.split("torrent_id_")[1];command("start_torrent",a)},stop:function(a){a=a.id.split("torrent_id_")[1];command("stop_torrent",a)},remove:function(a){a=a.id.split("torrent_id_")[1];command("remove_torrent",a)},"delete":function(a){a=a.id.split("torrent_id_")[1];command("delete_query",a)},rehash:function(a){a=a.id.split("torrent_id_")[1];command("hash_torrent",a)}},menuStyle:{minWidth:"10em"}});
$(".torrent-div.rcpause").contextMenu("right_click_pause",{bindings:{pause:function(a){a=a.id.split("torrent_id_")[1];command("pause_torrent",a)},stop:function(a){a=a.id.split("torrent_id_")[1];command("stop_torrent",a)},remove:function(a){a=a.id.split("torrent_id_")[1];command("remove_torrent",a)},"delete":function(a){a=a.id.split("torrent_id_")[1];command("delete_torrent",a)},rehash:function(a){a=a.id.split("torrent_id_")[1];command("hash_torrent",a)}},menuStyle:{minWidth:"10em"}})}
function parse_content(a,b){data=JSON.parse(a);system=JSON.parse(data.system);$("#global_uprate").html(system.uprate+"/s");$("#global_uptot").html(system.uptot);$("#global_diskusage").html(system.diskused+" / "+system.disktotal);$("#global_downrate").html(system.downrate+"/s");$("#global_downtot").html(system.downtot);$("#global_memusage").html(system.memused+" / "+system.memtotal);$("#global_load1").html(system.load1);$("#global_load5").html(system.load5);$("#global_load15").html(system.load15);
$("#global_uptime").html(system.uptime);$("#global_cpuusage").html(system.cpuusage+"%");$("title").html("PyRT :: webUI :: Up "+system.uprate+"/s :: Down "+system.downrate+"/s");torrent_list=$("#torrent_list").find($("tr.torrent-div"));cur_t_ids=[];if(0<DROP_OPEN.length&&0<data.drop_down_keys.length)for(i=0;i<DROP_OPEN.length;i++)tid=DROP_OPEN[i],-1!==data.drop_down_keys.indexOf(tid)&&(htmldata=data.drop_downs[tid],cur_pane=1,$("#drop_down_container_"+tid).find(".slide").each(function(a,b){0!==$(b).find("h2.selected").length&&
(cur_pane=a+1)}),htmldata=accordionise($(htmldata),cur_pane),htmldata=filetreeise($(htmldata),tid),$("#newrow_torrent_id_"+tid+" > td").html(htmldata));for(i=0;i<torrent_list.length;i++){var c=$(torrent_list[i]).attr("id").split("torrent_id_")[1];cur_t_ids.push(c);if(-1==data.torrent_index.indexOf(c))$("#torrent_id_"+c).hasClass("old-torrent-row")||((DEL_INDEX=-1!=DELETING.indexOf(c))&&DELETING.splice(DEL_INDEX,1),remove_torrentrow(c));else{torrent_data=data.torrents[c];torrent_data.completed?$("#t_name_"+
c).removeClass("progress-gradient"):$("#t_name_"+c).addClass("progress-gradient").css({"background-size":torrent_data.percentage+"% 100%, 100% 100%"});$("#t_ratio_"+c).html(torrent_data.ratio).attr("title",torrent_data.up_total+" up / "+torrent_data.down_total+" down");$("#t_uprate_"+c).html(torrent_data.uprate+"/s");$("#t_downrate_"+c).html(torrent_data.downrate+"/s");var e=$("#t_status_"+c),f=e.html();f!=torrent_data.status&&(e.html(torrent_data.status),-1!=$.inArray(f,statusArrayActive)&&-1!=$.inArray(torrent_data.status,
statusArrayInactive)?($("#t_controls_"+c+" > .control_pause").replaceWith($("<span />").addClass("control_start control_button").attr("title","Start Torrent").append($("<img />").addClass("control_image control_start_me").attr("alt","Start").attr("src","../images/start.png"))),$("#torrent_id_"+c).toggleClass("rcpause rcstart"),loadRClickMenus()):-1!=$.inArray(f,statusArrayInactive)&&-1!=$.inArray(torrent_data.status,statusArrayActive)&&($("#t_controls_"+c+" > .control_start").replaceWith($("<span />").addClass("control_pause control_button").attr("title",
"Pause Torrent").append($("<img />").addClass("control_image control_pause_me").attr("alt","Pause").attr("src","../images/pause.png"))),$("#torrent_id_"+c).toggleClass("rcpause rcstart")))}}for(i=0;i<data.torrent_index.length;i++)c=data.torrent_index[i],-1===$.inArray(c,cur_t_ids)&&add_torrentrow(c,data.torrents[c],i);loadRClickMenus();"yes"===b&&setTimeout(function(){refresh_content("yes")},refresh_rate)}
function refresh_content(a){req=0<DROP_OPEN.length?"request=get_info_multi&view="+$("#this_view").html()+"&drop_down_ids="+DROP_OPEN.join(","):"request=get_info_multi&view="+$("#this_view").html();"none"!==$("#this_sort").html()&&(req+="&sortby="+$("#this_sort").html());"none"!==$("#this_reverse").html()&&(req+="&reverse="+$("#this_reverse").html());ws.send(req)}
function remove_torrentrow(a){var b=$("#torrent_id_"+a);0!=b.length&&($(b).removeClass("blue green").toggleClass("old-torrent-row"),$(b).effect("pulsate",{times:1},"slow",function(){$(b).fadeTo(2E3,.1,function(){$(this).slideRow("up",1E3,function(){$("#torrent_id_"+a).remove()})})}))}
function add_torrentrow(a,b,c){var e=$("<tr />").addClass("torrent-div").attr("id","torrent_id_"+a);b.completed?e.append($("<td />").attr("id","t_name_"+a).addClass("t_name").html(b.name)):e.append($("<td />").attr("id","t_name_"+a).html(b.name).addClass("progress-gradient t_name").css("background-size",b.percentage+"%, auto"));e.append($("<td />").attr("id","t_size_"+a).html(b.size)).append($("<td />").attr("id","t_ratio_"+a).attr("title",b.up_total+" up / "+b.down_total+" down").html(b.ratio)).append($("<td />").attr("id",
"t_uprate_"+a).html(b.uprate+"/s")).append($("<td />").attr("id","t_downrate_"+a).html(b.downrate+"/s")).append($("<td />").attr("id","t_status_"+a).html(b.status)).append($("<td />").attr("id","t_controls_"+a).append($("<span />").addClass("control_stop control_button").attr("title","Stop Torrent").append($("<img />").addClass("control_image control_stop_me").css("padding-right","4px").attr("alt","Stop").attr("src","../images/stop.png"))).append($("<span />").addClass("control_remove control_button").attr("title",
"Remove Torrent").append($("<img />").addClass("control_image control_remove_me").css("padding-right","4px").attr("alt","Remove").attr("src","../images/remove.png"))).append($("<span />").addClass("control_delete control_button").attr("title","Remove Torrent and Files").append($("<img />").addClass("control_image control_delete_me").css("padding-right","4px").attr("alt","Delete").attr("src","../images/delete.png"))));-1!=$.inArray(b.status,statusArrayActive)?(e.addClass("rcpause"),e.find("td#t_controls_"+
a).prepend($("<span />").addClass("control_pause control_button").attr("title","Pause Torrent").append($("<img />").addClass("control_image control_pause_me").css("padding-right","4px").attr("alt","Pause").attr("src","../images/pause.png")))):(e.addClass("rcstart"),e.find("td#t_controls_"+a).prepend($("<span />").addClass("control_start control_button").attr("title","Start Torrent").append($("<img />").addClass("control_image control_start_me").css("padding-right","4px").attr("alt","Start").attr("src",
"../images/start.png"))));$("#torrent_list > tbody > tr:eq("+c+")").after(e)}function select_torrent(a){-1!==SELECTED.indexOf(a.id)&&SHIFT_SELECTED&&(a.style.backgroundColor="#fe0701")}function deselect_torrent(a){-1!==SELECTED.indexOf(a.id)&&(a.style.backgroundColor="#7ae41b")}function removerow(a){(row=document.getElementById("newrow_torrent_id_"+a))&&document.getElementById("torrent_list").deleteRow(row.rowIndex)}
function drop_down(a){var b=a.id.split("torrent_id_")[1];DROP_OPEN.push(b);var c=document.getElementById("torrent_list");(oldrow=document.getElementById("newrow_torrent_id_"+b))&&c.deleteRow(oldrow.rowIndex);a=c.insertRow(a.rowIndex+1);c=a.insertCell(0);a.id="newrow_torrent_id_"+b;a.className+="drop_down";c.id="newcell_torrent_id_"+b;c.innerHTML="<img src='images/loading.gif'> <span style='color:red;'>Loading</span>";c.colSpan="7";ws.send("request=get_torrent_info&html=yesplease&torrent_id="+b)}
function drop_up(a){drop_index=DROP_OPEN.indexOf(torrent_id);DROP_OPEN.splice(drop_index,1);$("#newrow_torrent_id_"+a+" > td > div").slideUp("slow",function(){$("#newrow_torrent_id_"+a).remove()})}function accordionise(a,b){a.liteAccordion({containerWidth:$(".torrent-div").first().width(),firstSlide:b});return a}function filetreeise(a,b){a.find("#drop_down_files_"+b+" > ul").treeview({collapsed:!0,persist:"cookie"});return a}
function command(a,b){if(-1!=$.inArray(b,DELETING))return!1;if("pause_torrent"===a||"start_torrent"===a||"stop_torrent"===a||"remove_torrent"==a||"delete_query"==a||"hash_torrent"==a){var c;if("remove_torrent"===a)c=confirm("Are you sure you want to remove this torrent?");else if("delete_torrent"==a){if(c=confirm("Are you sure you want to remove this torrent and *permanently* delete its files?"))$("#torrent_id_"+b).addClass("deleting-torrent-row").removeClass("blue green"),DELETING.push(b)}else c=
"hash_torrent"==a?confirm("Are you sure you want to rehash this torrent?\n This process can take a long time for large torrents"):!0;if(c)ws.send("request="+a+"&torrent_id="+b);else return!1}else console.log("invalid command or command not implemented")}
function createDragOverlay(){if(dragOverlayOpen)return!1;dragOverlayCreated=(new Date).getTime();dragOverlayOpen=!0;var a=$("<div />").addClass("dragOverlay").appendTo("body");$("<div id='dragOverlayDialog' />").addClass("dragOverlayDialog").appendTo(a)}function destroyDragOverlay(){dragOverlayOpen&&(dragOverlayOpen=!1,$(".dragOverlay").each(function(a){$(this).fadeOut(2E3,function(){$(this).remove()})}))}
function delete_dialog(a,b,c){$("#delete_confirmation").attr("data-torrent_id",b);c?$("#delete_message").show().html(c):$("#delete_message").hide();$(".delete_target").html(a);$("#delete_confirmation").dialog("open")}
function messageHandler(a){if("pong"!=a.data){d=JSON.parse(a.data);if("get_info_multi"==d.request)return parse_content(d.response,"yes");if("get_refresh_rate"==d.request)refresh_rate=1E3*parseInt(d.response);else if("get_torrent_info"==d.request)newcellcontents=$(d.response),a=$(".drop_down_main",newcellcontents).first().attr("id").split("drop_down_main_")[1],a=document.getElementById("newcell_torrent_id_"+a),a.className+="drop_down_td",newcellcontents=accordionise(newcellcontents,1),newcellcontents=
filetreeise(newcellcontents,torrent_id),newcellcontents.css({display:"none"}),$(a).html(newcellcontents),newcellcontents.slideDown("slow");else if("delete_query_batch"==d.request){a=d.response;console.log("delete_query_batch response: ",a);for(i=0;i<a.torrents.length;i++){var b=document.createElement("span");b.className+="delete_target";"CONFIRM"==a.torrents[i].result&&(b.classList+=" delete_confirm");b.innerHTML=a.torrents[i].target;b.style.padding=0;$(b).attr("data-torrent_id",a.torrents[i].torrent_id);
$("#delete_targets").append(b)}$("#delete_confirmation_batch").dialog("open")}else"delete_query"==d.request?(a=d.response,"OK"==a.result?delete_dialog(a.target,a.torrent_id,null):"CONFIRM"==a.result&&(msg="extra"==a.message?"There are extra files in directory '"+a.target+"'":"size"==a.message?"Directory '"+a.target+"' size is unexpected":"Unknown reason (report this)",delete_dialog(a.target,a.torrent_id,msg))):"pause_torrent"==d.request||"start_torrent"===d.request||"stop_torrent"===d.request||"remove_torrent"==
d.request||"delete_torrent"==d.request||"hash_torrent"==d.request?(a=d.response.trim(),"OK"!=a&&console.log("Command Failed with reason: "+a)):"download_file"==d.request?d.error?alert("Error in download handler: "+d.error):(a=d.response,console.log("Authkey is: "+a),window.open("download?auth="+a,"downloadPage")):console.log("Unknown request")}};
